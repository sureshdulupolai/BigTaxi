<!-- customer_login.html -->
{% extends 'base.html' %}
{% block body %}
<style>
  body { background-color: #f8fafc; }
  .form-section {
    background-color: #ffffff;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    margin-top: 2rem;
    text-align: center;
  }
  h4 { color: #007bff; margin-bottom: 1.5rem; }
  .eye-top{
    margin-top: 16px;
  }
  .w-pin-taxi{
    width: 45% !important;
  }
  
  .button-home:hover{
    background-color: gold;
  }
  .button-home-red:hover{
    color: red;
    color: white;
  }
  .taxi-passenger-limit-text{
    color: gray;
  }
</style>

{% if DataShow %}
  <div class="container mb-4">
    <div class="form-section">
      <h4>Customer Need To Pin Taxi</h4>

      {% if messages %}
        <div>
          {% for message in messages %}
            <div 
              class="alert 
              {% if message.tags == 'success' %}alert-success
              {% elif message.tags == 'warning' %}alert-warning
              {% else %}alert-info{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="POST">
        {% csrf_token %}

        <div class="mb-3 text-start position-relative">
          <label class="form-label">Passenger :</label>
          <input type="number" class="form-control" name="uTaxiPassenger" min="0" placeholder="maximum no of passenger travel*" required>
        </div>

        <div class="mb-3 text-start position-relative">
          <label class="form-label">Current Location Address :</label>
          <input type="text" class="form-control" name="uCurrentLocation" placeholder="enter your current address*" required>
        </div>

        <div class="mb-3 text-start position-relative">
          <label class="form-label">To Location Address :</label>
          <input type="text" class="form-control" name="uLastLocation" placeholder="enter your last destination*" required>
        </div>

        <div class="mb-3 text-start position-relative">
          <label class="form-label">Pincode :</label>
          <input type="number" class="form-control" name="uPincode" placeholder="enter your pincode*" required>
        </div>

        {% if userCategoryis == 'Customer' %}
          <div class="mb-3 text-start position-relative">
            <label class="form-label">Coupon Code :</label>
            <input type="text" class="form-control" name="uCouponCode" placeholder="Discount Coupon Code">
            <input type="text" class="form-control" name="uVerifyStatus" value="{{ userCategoryis }}" hidden>
            <input type="text" class="form-control" name="uBarCode" value="{{ userBarCodeAccessis }}" hidden>
          </div>

        {% elif userCategoryis == 'Driver' %}
          <input type="text" class="form-control" name="uVerifyStatus" value="{{ userCategoryis }}" hidden>
          <input type="text" class="form-control" name="uBarCode" value="{{ userBarCodeAccessis }}" hidden>
        {% endif %}

        <input type="text" class="form-control" name="uCity" id="user-city" value="" hidden>

        <div class="w-100 d-flex justify-content-center gap-5">
          <a href="{% url 'taxi_app:home' %}" class="btn btn-primary w-pin-taxi">Back</a>
          <button type="submit"  class="btn btn-success w-pin-taxi">Post</button>
        </div>
      </form>
    </div>
  </div>
{% else %}
  <div class="container mt-5">
  <div class="alert text-center">
    You have already pinned 2 taxis. To add another, please unpin one first.
  </div>
</div>
{% endif %}


  {% if valueOfPin %}
    {% for DP in dataOfPin %}
      <!-- Main Profile Card -->
      <div class="container-xxl my-3">
      <div class="bg-white shadow-sm rounded p-3 d-flex align-items-center flex-wrap flex-md-nowrap">
        
        <!-- Profile Image -->
        <div class="me-4 mb-3 mb-md-0">
          <img src="/media/{{ profileImage }}" alt="User Profile"
              class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
        </div>
        
        <!-- User Info -->
        <div class="me-auto">
          <h4 class="mb-1">{{ usernames }}</span></h4>
          <p class="text-muted mb-0">from: {{ DP.currentLocation|truncatewords:7 }}, {{ DP.taxiCity }}</p>
          <p class="text-muted mb-0">to: {{ DP.toLocation|truncatewords:7 }}</p>
          <p class="text-muted mb-0">passenger: {{ DP.taxiPassenger }}</p>
        </div>
        
        <!-- Book Taxi Button -->
        <div class="mt-3 mt-md-0">
          <a href="#" class="btn btn-info">Edit</a>
          <a href="#" class="btn btn-warning button-home">Check Status</a>
          <a href="#" class="btn btn-danger button-home-red">Cancel</a>
        </div>

      </div>
    </div>
    {% endfor %}
    {% endif %}

<script>
  fetch('https://ipapi.co/json/')
  .then(res => res.json())
  .then(data => {
    console.log("City:", data.city);
    console.log("State:", data.region);
    // input field ke value mein city set karo
    document.getElementById('user-city').value = data.city;
  })
  .catch(err => console.error('Error fetching city:', err));

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    function (position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      console.log("Latitude:", lat);
      console.log("Longitude:", lon);

      // Reverse Geocoding from OpenStreetMap
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
        .then(res => res.json())
        .then(data => {
          const address = data.display_name;
          const pincode = data.address.postcode;

          console.log("Full Address:", address);
          console.log("Pincode:", pincode);
        })
        .catch(err => console.error("Error in reverse geocoding:", err));
    },
    function (error) {
      console.error("Error getting location:", error.message);
    }
  );
} else {
  console.log("Geolocation is not supported by this browser.");
}

</script>
{% endblock %}